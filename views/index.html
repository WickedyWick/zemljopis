<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx" crossorigin="anonymous"></script>
        <title>Zemljopis</title>
    </head>
    <body>
        
            <div class="alert alert-danger" id="danger-alert">
                    <!--<a href="#" class="close" data-dismiss="alert">&times;</a>-->
                    <strong>Success!</strong> Your message has been sent successfully.
                </div>
        <script>
            $("#danger-alert").hide(); 
        </script>
        <div style="margin-top:5%;margin-left:20%;margin-right:20%;">
            <h1><center>Zemljopis</center></h1>
            <div class="form-row">
                <div class="col">
                    <input type="text" class="form-control" id="txb_roomCode" placeholder="Room code">
                </div>
                <div class="col">
                    <input type="text" class="form-control" id="txb_username" placeholder="Player name" required>
                </div>
                <div class="col">
                    <select class="form-control" id="playerNumber">
                        <option>1</option>
                        <option>2</option>
                        <option>3</option>
                        <option>4</option>
                        <option>5</option>
                        <option>6</option>
                        <option>7</option>
                        <option>8</option>
                        <option>9</option>
                        <option>10</option>
                    </select>
                </div>     
                <div class="col">
                    <select class="form-control" id="roundTimeLimit">
                        <option>60</option>
                        <option>90</option>
                        <option>120</option>
                    </select>
                </div>            
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" value="" id="chb_Rejoin">
                    <label class="form-check-label" for="defaultCheck1">
                      Rejoin
                    </label>
                  </div>
            </div>
            <button class="btn btn-dark" id="napravi">Napravi sobu</button>
            <button class="btn btn-dark" id="pridruzi">Pridruzi se sobi</button>
        </div>  
        <!--<div class="input-group mb-3">
            <div class="input-group-prepend" style="margin-top:2%;margin-left:10%;margin-right:10%">
                <input id="txb" type='text' class='form-control'>    
                <button class='btn btn-dark' id='napravi'>Napravi sobu</button>
                <button class='btn btn-dark' id="pridruzi">Pridruži se</button>
            </div>
    </div>-->
    
    </body>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qs/6.9.4/qs.min.js" integrity="sha512-BHtomM5XDcUy7tDNcrcX1Eh0RogdWiMdXl3wJcKB3PFekXb3l5aDzymaTher61u6vEZySnoC/SAj2Y/p918Y3w==" crossorigin="anonymous"></script>
 
    <script>
        document.body.style.backgroundImage = `url(/public/images/bg2.png)`
        /*
        let index = Math.floor(Math.random() * 2)
        document.body.style.backgroundImage = `url(/public/images/bg${index}.png)`
        setInterval(()=>{
        
        index ++ 
        if(index >2)
            index = 0

        document.body.style.backgroundImage = `url(/public/images/bg${index}.png)`
        },5000)
        */
                
            
  
        const socket = io('http://46.40.27.131:3000/');
        const userReg = RegExp("[0-9A-Za-z]{4,30}\g");
        const roomReg = RegExp("[0-9A-Za-z]{8}\g")
        socket.on('message', message =>{
            console.log(message)
        })
        //TODO dodaj type reconnect 
        socket.on('createRoomSQLResponse',response =>{
            console.log(response)
            if(response["Success"] == false)
                myAlert('There was a problem while creating a room ,please try later')
            else
            {
                localStorage.setItem('sessionToken',response['sessionToken'])
                console.log(response['sessionToken'])
                window.location.href = `http://46.40.27.131:3000/game?roomCode=${response['roomCode']}&username=${response['username']}`;

            }
        })
        socket.on('joinRoomSQLResponse' , response=>{
            console.log(response)
            if(response["Success"] == false)
                //make this more robust
                myAlert(response["ERR_MSG"])
            else
            {
                localStorage.setItem('sessionToken')
                window.location.href = `http://46.40.27.131:3000/game?roomCode=${response['roomCode']}&username=${response['username']}`
            }
            
        })
        function myAlert(test){
            $("#danger-alert").html(`<a href="#" class="close" data-dismiss="alert">&times;</a><strong>Failure</strong> ${test}`)
            $("#danger-alert").fadeTo(7000, 500).slideUp(500, () =>{
                $("#danger-alert").slideUp(500);
            });   
        }
        

        //dodaj ova govna
        document.getElementById('pridruzi').addEventListener('click',(e)=>{
            let roomReg = /^[A-Za-z0-9]{8}$/g
            const usernameReg = /^[A-Za-zčČćĆžŽšŠđĐ ]{4,30}$/g
            e.preventDefault();
            let username = document.getElementById('txb_username').value.trim()
            let room = document.getElementById('txb_roomCode').value.trim()
            if(roomReg.test(room) && usernameReg.test(username)){
       
                let rejoin = document.getElementById('chb_Rejoin').checked // true/false
                
                /*if(userReg.test(username) && roomReg.test(room))
                    console.log("Pridruzi")
                    //socket.emit('joinRoom',{username,room})
                else
                myAlert("Username must be longer than 4 and shorter than 30 characters, only numbers and letters\nRoom code must be 8 characters long")
                */
                if(rejoin){
                    window.location.href = `http://46.40.27.131:3000/game?roomCode=${room}&username=${username}`;
                }else{
                    socket.emit('joinRoomSQL',{username,room})
                }
                //pop alert
            }else{
                if(!roomReg.test(room) && !usernameReg(username)){
                    //mylaertuj za o
                    myAlert('Korisnicko ime mora da bude barem 4 karaktera dugacko, dozvoljena pisma su sprska latinica i engleski alfabet!\nSoba se sastoji od 8 alfanumerickih karaktetra!')
                }else if(!roomReg(room)){
                    // ako je soba invalidnog formata
                    myAlert('Soba se sastoji od 8 alfanumerickih karaktetra!')
                }
                else{
                    //ako je useranme invalidnog formnata
                    myAlert('Korisnicko ime mora da bude barem 4 karaktera dugacko, dozvoljena pisma su sprska latinica i engleski alfabet!')
                }
            }
        })
       
        document.getElementById('napravi').addEventListener('click',(e)=>{
            e.preventDefault(); 
            let username = document.getElementById('txb_username').value.trim()
            let reg = /^[A-Za-zčČćĆžŽšŠđĐ ]{4,60}$/g
            if(reg.test(username)){
                let playerCount = document.getElementById('playerNumber').value
                console.log(playerCount)
                let roundTimeLimit = document.getElementById('roundTimeLimit').value
                /*if(userReg.test(username))
                    console.log("Napravi")
                    //socket.emit('createRoom',username)
                else
                    myAlert("Username must be longer than 4 and shorter than 30 characters, only numbers and letters")
                    //pop awlert
                */
                socket.emit('createRoom',{username,playerCount,roundTimeLimit})
            }else{
                myAlert("Korisnicko ime mora da bude barem 4 karaktera dugacko, dozvoljena pisma su sprska latinica i engleski alfabet!")
            }
        })
        
        
        /*
        document.getElementById('napravi').addEventListener('click',(e) =>{
            e.preventDefault()
            /*
            const {username, room} = Qs.parse(location.search,{
                ignoreQueryPrefix: true
            })
            
            //Join room
            
            
                
        })
              */  
    </script>
</html>