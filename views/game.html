<!DOCTYPE html>
<html>
    <head>
        <title>Zemljopis</title>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx" crossorigin="anonymous"></script>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/noty/3.1.4/noty.css" integrity="sha512-NXUhxhkDgZYOMjaIgd89zF2w51Mub53Ru3zCNp5LTlEzMbNNAjTjDbpURYGS5Mop2cU4b7re1nOIucsVlrx9fA==" crossorigin="anonymous" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
    </head>
    <style>
      html,body{
        max-width: 100%;
        overflow-x: hidden;
      }
      @media only screen and (max-width: 1099.9px) {
        .nameLabel:hover{
          border-style:solid;
              border-width:1px;
              border-color: black;
              text-decoration: none;
              border-radius : 25%;
              cursor: pointer;
        }
        span:hover{
              border-style:solid;
              border-width:1px;
              border-color: black;
              text-decoration: none;
              border-radius : 25%;
              cursor: pointer;
            }
        
        .myFlexContainer{
                display:flex;
                flex-direction: column;             
                justify-content: center;
                margin-left:10%;
                margin-right:5%;
                margin-top:1%;                
                align-content: center;
                
            }
        ul{
            list-style-type:none;
            max-height: 100px;
            overflow-y:scroll;
        }
        li{
            padding-left:0.75rem;
        }
        .myBtn{
          margin-top:5px;
        }
    }

    @media only screen and (min-width: 1100.0px) {
            .nameLabel:hover{
                border-style:solid;
                    border-width:1px;
                    border-color: black;
                    text-decoration: none;
                    border-radius : 25%;
                    cursor: pointer;
            }
            span:hover{
              border-style:solid;
              border-width:1px;
              border-color: black;
              text-decoration: none;
              border-radius : 25%;
              cursor: pointer;
            }
            .myFlexContainer{
                display:flex;
                             
                justify-content: center;
                margin-left:25%;
                margin-right:5%;
                margin-top:1%;
                
                align-content: center;
                
            }
            .myFlexContainer > div{
                flex:1;
                flex-basis: 100%;
                
            }
            #first {
                padding-right:2rem;
                display:inline-flex;
                width:100%;
                
                
            }
            ul{
                list-style-type:none;
                max-height: 200px;
                overflow-y:scroll;
            }
            li{
                padding-left: 0.75rem;
            }
            #second{
                display:inline-flex;
                align-content: flex-end;
            }
            .support{
                display:flex;
                flex-direction: row;
            }
            .myBtn{
              margin-left:5px;
            }
            .myRow {
                display: flex;
                flex-direction: row;
                flex-wrap: nowrap;
                width: 100%;
            }
            .myColumn {

                display: flex;
                flex-direction: column;
                flex-basis: 100%;
                flex: 1;
            }
        }
    </style>
    <body>
        <nav class="navbar navbar-dark bg-dark" style="position:sticky">
                <a class="navbar-brand" href="/">Home</a>
                
        </nav>
            <div class="alert alert-danger" id="vote-alert" >
              <!--<strong>Success!</strong> Your message has been sent successfully-->
              </div>
        <script>
            $("#vote-alert").hide();
        </script>
        <!-- skontaj kako ces layout da namestis
        <table id="table" class="table table-bordered table-dark" >
            <thead class="thead-dark">
                <tr>
                    <th colspan="12" class="text-center">Zemljopis</th>
                </tr>
                <tr>
                    <th>#</th>
                    <th>Država</th>
                    <th>Grad</th>
                    <th>Ime</th>
                    <th>Biljka</th>
                    <th>Životinja</th>
                    <th>Planina</th>
                    <th>Reka</th>
                    <th>Predmet</th>
                    <th>Slovo</th>
                    <th>Bodovi</th>
                </tr>
            </thead>
            <tbody class="tbody-dark">
                
            </tbody>
        </table>
        <button onclick="dodaj()">xd</button>
        -->
        <div class="myFlexContainer myRow" id="maxDiv">
            <div class="myColumn" id="first">                        
                <div>
                  <label for="inputDrzava">Država</label>
                  <div class="support">
                    <input type="text" class="form-control" id="inputDrzava" aria-describedby="helpDrzava" placeholder="Unesi državu :"autocomplete="off">                
                    <button class="btn btn-dark myBtn" id="predloziBtnDrzava" onclick="predlozi('Drzava')">Predloži</button>
                  </div>
                  <small id="helpDrzava" class="form-text text-muted" style="display:none" >Polje moze da sadrzi samo slova i minimalna duzina je 2 karaktera.</small>
                  
                </div>
                <div class="form-group">
                    <label for="inputGrad">Grad</label>
                    <div class="support">
                      <input type="text" class="form-control" id="inputGrad" aria-describedby="helpGrad" placeholder="Unesi grad :" autocomplete="off">
                      <button class="btn btn-dark myBtn" id="predloziBtnGrad" onclick="predlozi('Grad')">Predloži</button>
                    </div>
                    <small id="helpGrad" class="form-text text-muted" style="display:none" >Polje moze da sadrzi samo slova i minimalna duzina je 2 karaktera.</small>
                </div>
                <div class="form-group">
                  <label for="inputIme">Ime</label>
                  <div class="support">
                    <input type="text" class="form-control" id="inputIme" aria-describedby="helpIme" placeholder="Unesi ime :" autocomplete="off">
                    <button class="btn btn-dark myBtn" id="predloziBtnIme" onclick="predlozi('Ime')" >Predloži</button>
                  </div>
                  <small id="helpIme" class="form-text text-muted" style="display:none" >Polje moze da sadrzi samo slova i minimalna duzina je 2 karaktera.</small>
                </div>
                <div class="form-group">
                  <label for="inputBiljka">Biljka</label>
                  <div class="support">
                    <input type="text" class="form-control" id="inputBiljka" aria-describedby="helpBiljka" placeholder="Unesi biljku :" autocomplete="off">
                    <button class="btn btn-dark myBtn" id="predloziBtnBiljka" onclick="predlozi('Biljka')">Predloži</button>
                  </div>  
                  <small id="helpBiljka" class="form-text text-muted" style="display:none" >Polje moze da sadrzi samo slova i minimalna duzina je 2 karaktera.</small>
                </div>
                <div class="form-group">
                  <label for="inputZivotinja">Životinja</label>
                  <div class="support">
                    <input type="text" class="form-control" id="inputZivotinja" aria-describedby="helpZivotinja" placeholder="Unesi životinju :" autocomplete="off">
                    <button class="btn btn-dark myBtn" id="predloziBtnZivotinja" onclick="predlozi('Zivotinja')">Predloži</button>
                  </div>
                  <small id="helpZivotinja" class="form-text text-muted" style="display:none" >Polje moze da sadrzi samo slova i minimalna duzina je 2 karaktera.</small>
                </div>
                <div class="form-group">
                  <label for="inputPlanina">Planina</label>
                  <div class="support">
                    <input type="text" class="form-control" id="inputPlanina" aria-describedby="helpPlanina" placeholder="Unesi planinu :" autocomplete="off">
                    <button class="btn btn-dark myBtn" id="predloziBtnPlanina" onclick="predlozi('Planina')">Predloži</button>
                  </div>
                  <small id="helpPlanina" class="form-text text-muted" style="display:none" >Polje moze da sadrzi samo slova i minimalna duzina je 2 karaktera.</small>
                </div>
                <div class="form-group">
                  <label for="inputReka">Reka</label>
                  <div class="support">
                    <input type="text" class="form-control" id="inputReka" aria-describedby="helpReka" placeholder="Unesi reku :" autocomplete="off">
                    <button class="btn btn-dark myBtn" id="predloziBtnReka" onclick="predlozi('Reka')">Predloži</button>
                  </div>
                  <small id="helpReka" class="form-text text-muted" style="display:none" >Polje moze da sadrzi samo slova i minimalna duzina je 2 karaktera.</small>
                </div>
                <div class="form-group">
                  <label for="inputPredmet">Predmet</label>
                  <div class="support">
                    <input type="text" class="form-control" id="inputPredmet" aria-describedby="helpPredmet" placeholder="Unesi predmet :" autocomplete="off">
                    <button class="btn btn-dark myBtn" id="predloziBtnPredmet" onclick="predlozi('Predmet')">Predloži</button>
                  </div>
                  <small id="helpPredmet" class="form-text text-muted" style="display:none" >Polje moze da sadrzi samo slova i minimalna duzina je 2 karaktera.</small>
                </div> 
              
            </div>
            <div class="myColumn" id="second">
                <div>
                    <button class="btn btn-primary" id="btnReady" style="background-color:red;">Not ready</button>
                </div> 
                <div id="sobaDiv">
                    <label id="lblRoomCode">Soba : </label>
                </div>  
                <div id="playersDiv">
                    <label>Igači spremni : </label>
                    <label id="lblPlayersReady"></label>
                    <label>/</label>
                    <label id="lblPlayerCount"></label>
                </div>
              <div>
                <select id="roundSelect">
                  
                </select>
              </div>
              <div id="rundaDiv">
                <label>Runda : </label>
                <label id="roundNumber">1</label>
                <label id="currentLetter"></label>
                <br>
                <label>Poeni : </label>
                <label id="poeni">0</label>
            </div>
            <div>
                    <label>Vreme : </label>
                    <label id="counter"></label>
            </div>
            <div>
                <label >Igrači : <label id="localPlayer" class="nameLabel"></label></label>
                <ul id="players">                   
                </ul>
            </div>
            
          </div>
      </div>
    </body>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qs/6.9.4/qs.min.js" integrity="sha512-BHtomM5XDcUy7tDNcrcX1Eh0RogdWiMdXl3wJcKB3PFekXb3l5aDzymaTher61u6vEZySnoC/SAj2Y/p918Y3w==" crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/noty/3.1.4/noty.min.js" integrity="sha512-lOrm9FgT1LKOJRUXF3tp6QaMorJftUjowOWiDcG5GFZ/q7ukof19V0HKx/GWzXCdt9zYju3/KhBNdCLzK8b90Q==" crossorigin="anonymous"></script>
    <script src="../public/javascripts/config.js"></script>
    <script>
        data = {}
        const {username, roomCode} = Qs.parse(location.search,{
                ignoreQueryPrefix: true
            })
        let readyBtn = document.getElementById('btnReady')
        let gameStarted = false
        let ready = false;
        let timer = document.getElementById('counter')
        let myInterval;
        let roundNumber;
        let t0;
        let t1;
        let points = 0;
        let currentLetter = ''
        let dataReg = new RegExp()
        let pList = {}
        let kicked = false
        let historyData = {}
        historyData[username] = {}
        let select = document.getElementById('roundSelect')
        const fields = ['Drzava','Grad','Ime','Biljka','Zivotinja','Planina','Reka','Predmet']
        const dataDictKeys = ['drzava','grad','ime','biljka','zivotinja','planina','reka','predmet']
        const kDict = {'Drzava':'d','Grad':'g','Ime':'i','Biljka':'b','Zivotinja':'z','Planina':'p','Reka':'r','Predmet':'pr'}
        const sessionReg = /^[A-Za-z0-9/+]{48}$/g
        
        $(`#helpGrad`).css("visibility", "visible")
        
        // dodaj start button za leadera
        serverAddress = serverAdress()
        const socket = io(serverAddress);
        socket.on('message', message =>{
           
        })
        
        socket.on('joinMessage', message =>{
            
        })
        function disableAllPButtons(){
          $("#predloziBtnDrzava").prop("disabled", true )
          $("#predloziBtnGrad").prop("disabled", true )
          $("#predloziBtnIme").prop("disabled", true )
          $("#predloziBtnBiljka").prop("disabled", true )
          $("#predloziBtnZivotinja").prop("disabled", true )
          $("#predloziBtnPlanina").prop("disabled", true )
          $("#predloziBtnReka").prop("disabled", true )
          $("#predloziBtnPredmet").prop("disabled", true )
        }
        function enableAllPButtons(){
          $("#predloziBtnDrzava").prop("disabled", false )
          $("#predloziBtnGrad").prop("disabled", false )
          $("#predloziBtnIme").prop("disabled", false )
          $("#predloziBtnBiljka").prop("disabled", false )
          $("#predloziBtnZivotinja").prop("disabled", false )
          $("#predloziBtnPlanina").prop("disabled", false )
          $("#predloziBtnReka").prop("disabled", false )
          $("#predloziBtnPredmet").prop("disabled", false )
        }
        function hideAllHelp(){
          $("#helpDrzava").hide()
          $("#helpGrad").hide()
          $("#helpPredmet").hide()
          $("#helpIme").hide()
          $("#helpBiljka").hide()
          $("#helpReka").hide()
          $("#helpPlanina").hide()
          $("#helpZivotinja").hide()
        }
        function clearAllInputFields(){
          $("#inputDrzava").val('')
          $("#inputGrad").val('')
          $("#inputPredmet").val('')
          $("#inputIme").val('')
          $("#inputBiljka").val('')
          $("#inputReka").val('')
          $("#inputPlanina").val('')
          $("#inputZivotinja").val('')
        }
        function disableAllInputFields(){
          $("#inputDrzava").prop("disabled", true )
          $("#inputGrad").prop("disabled", true )
          $("#inputPredmet").prop("disabled", true )
          $("#inputIme").prop("disabled", true )
          $("#inputBiljka").prop("disabled", true )
          $("#inputReka").prop("disabled", true )
          $("#inputPlanina").prop("disabled", true )
          $("#inputZivotinja").prop("disabled", true )

        }
        function enableAllInputFields(){
          $("#inputDrzava").prop("disabled", false )
          $("#inputGrad").prop("disabled", false )
          $("#inputPredmet").prop("disabled", false )
          $("#inputIme").prop("disabled", false )
          $("#inputBiljka").prop("disabled", false )
          $("#inputReka").prop("disabled", false )
          $("#inputPlanina").prop("disabled", false )
          $("#inputZivotinja").prop("disabled", false )

        }
        function disableHistoryReq(){
          let keys = Object.keys(pList)
          $("#localPlayer").css("pointer-events","none");
          for(let i =0;i<keys.length;i++){
            $(`#${keys[i]}`).css("pointer-events","none")
          }
        }
        function enableHistoryReq(){
          let keys = Object.keys(pList)
          $("#localPlayer").css("pointer-events","auto");
          for(let i =0;i<keys.length;i++){
            $(`#${keys[i]}`).css("pointer-events","auto")
          }
        }
        //popup alert multi use
        function myAlert(test){
            $("#vote-alert").show()
            $("#vote-alert").html(`<a href="#" class="close" data-dismiss="alert" >&times;</a><label class="vLabel">Glasanje da se izbaci igrač : ${test}</label> <button class="btn myVBtn" id="forVoteKick" onclick="voteFor()">Za</button><button class="btn myVBtn" id="againstVoteKick" onclick="voteAgainst()">Protiv</button> `)
           
            $("#vote-alert").fadeTo(7000)
              
            
            
        }
        // glas za
        function voteFor(){
          mode = "FOR"
          socket.emit("voteKickCounter",({username,roomCode,mode}))
          $("#vote-alert").html("")
          $("#vote-alert").slideUp(500)
          $("#vote-alert").hide()
          
        }
        //glas protiv
        function voteAgainst(){
          mode = "AGAINST"
          socket.emit("voteKickCounter",({username,roomCode,mode}))
          $("#vote-alert").html("")
          $("#vote-alert").slideUp(500)
          $("#vote-alert").hide()
        }
        //funcija za trazenje istorije drugih igraca
        function historyReq(player){
          $(`#${player}`).css("pointer-events","none"); 
          let targetRound = select.value
          disableAllPButtons()
          disableAllInputFields()
          console.log(historyData) 
          if(targetRound != roundNumber){
            if(player in historyData){
              if(targetRound in historyData[player]){
                let arr = historyData[player][targetRound] 
                console.log(arr)
                for(let i =0;i < dataDictKeys.length;i++){
                  $(`#input${fields[i]}`).val(arr[i])
                
                }
                $(`#${player}`).css("pointer-events","auto");
              }else{
                socket.emit('historyReq',({roomCode,player,targetRound}))
              }
            }else{
              //socket emituj request za rundu i username
              historyData[player] = {}
              socket.emit('historyReq',({roomCode,player,targetRound}))
            }
          }else{
            new Noty({
                  theme : 'metroui',
                  type : 'info',
                  layout : 'topRight',
                  text : `Trenutna runda još nije završena.`,
                  timeout : 5000,
                  progressBar :true
                }).show()
                $(`#${player}`).css("pointer-events","auto");
          }
         
        }
        //ako localplayer trazi istoriju
        document.getElementById("localPlayer").addEventListener('click',(e)=>{
          $("#localPlayer").css("pointer-events","none"); //not clicable 
          let targetRound = select.value
          disableAllInputFields()
          disableAllPButtons()
          if(targetRound != roundNumber){
            if(username in historyData){
              if(targetRound in historyData[username]){
                let arr = historyData[username][targetRound]
                for(let i =0;i < dataDictKeys.length;i++){
                  $(`#input${fields[i]}`).val(arr[i])
                  
                }
                $("#localPlayer").css("pointer-events","auto");
              }else{
                let player = username
                socket.emit('historyReq',({roomCode,player,targetRound}))
              }
            }else{
              historyData[username] = {}
              let player = username
              socket.emit('historyReq',({roomCode,player,targetRound}))
            }
          }else{
            new Noty({
                  theme : 'metroui',
                  type : 'info',
                  layout : 'topRight',
                  text : `Trenutna runda još nije završena.`,
                  timeout : 5000,
                  progressBar :true
                }).show()
                $("#localPlayer").css("pointer-events","auto");
          }
          
          //alert('test')
        })
        //daje requestovane podatke istorije
        socket.on('historyReqResponse',message=>{
          console.log(message)
          enableHistoryReq()
          
          if(message['Success']){
            new Noty({
                  theme : 'metroui',
                  type : 'info',
                  layout : 'topRight',
                  text : `Prikazani podaci za ${message['username']} u rundi ${message['round']}`,
                  timeout : 5000,
                  progressBar :true
                }).show()
              let data = message['Data']
              let arr = []
              //historyData[message['username']][message['round']] = data
              if(message['username'] == username){
                for(let i =0;i < dataDictKeys.length;i++){
                  $(`#input${fields[i]}`).val(data[dataDictKeys[i]])
                  arr.push(data[dataDictKeys[i]])
                  
                }               
              }else{
                for(let i =0;i < dataDictKeys.length;i++){
                  $(`#input${fields[i]}`).val(data[dataDictKeys[i]])
                  arr.push(data[dataDictKeys[i]])
                  
                }
              }
              historyData[message['username']][message['round']] = arr           
          }else{
            new Noty({
                  theme : 'metroui',
                  type : 'warning',
                  layout : 'topRight',
                  text : message['ERR_MSG'],
                  timeout : 5000,
                  progressBar :true
                }).show()
          }
        })
        //rezultat kikovanja
        socket.on('kickResult',message=>{
          if(message['Success']){
            if(message['username'] == username){
              kicked = true;
              if(ready)
                socket.emit('playerUnReady',roomCode)              
              $("#vote-alert").html("")
              $("#vote-alert").hide()             
              $("#maxDiv").hide()
              new Noty({
                  theme : 'metroui',
                  type : 'error',
                  layout : 'topRight',
                  text : message['SPEC_MSG'],
                  timeout : 5000,
                  progressBar :true
                }).show()
                setTimeout(()=>{
                  window.location.href = "/"
              },5000)
            }else{
              $("#vote-alert").html("")
              $("#vote-alert").hide()
              document.getElementById('lblPlayerCount').textContent = String(Number(document.getElementById('lblPlayerCount').textContent) -1)
              node = document.getElementById(`${message['username']}`)
              node.parentNode.removeChild(node);
              delete pList[message['username']]
              let keys = Object.keys(pList)
              for(let i=0;i<keys.length;i++){
                $(`#span${keys[i]}`).css('pointer-events','auto')
              }
              new Noty({
                  theme : 'metroui',
                  type : 'success',
                  layout : 'topRight',
                  text : message['MSG'],
                  timeout : 5000,
                  progressBar :true
                }).show()                
            }
          }else{
            $("#vote-alert").html("")
            $("#vote-alert").hide()
            let keys = Object.keys(pList)
            for(let i=0;i<keys.length;i++){
                $(`#span${keys[i]}`).css('pointer-events','auto')
              }
            new Noty({
                  theme : 'metroui',
                  type : 'info',
                  layout : 'topRight',
                  text : message['ERR_MSG'],
                  timeout : 5000,
                  progressBar :true
                }).show()
          }
        })
        //vote response notifikaicja
        socket.on('voteKickCounterResponse',message=>{
          if(message['Success'])
          new Noty({
                  theme : 'metroui',
                  type : 'success',
                  layout : 'topRight',
                  text : message['MSG'],
                  timeout : 5000,
                  progressBar :true
                }).show()
          else
          new Noty({
                  theme : 'metroui',
                  type : 'error',
                  layout : 'topRight',
                  text : message['ERR_MSG'],
                  timeout : 5000,
                  progressBar :true
                }).show()
        })
        //glavni load listter
        //prikazuje sve podatke potrebne
        socket.on('load', message =>{
          if(message['Success']){
            
            $('#maxDiv').show()
            disableAllPButtons()
            sessionToken = localStorage.getItem('sessionToken')
            document.getElementById('localPlayer').textContent = username
            
            document.getElementById('lblRoomCode').textContent += String(roomCode)
            document.getElementById('lblPlayersReady').textContent = message['playersReady']
            document.getElementById('lblPlayerCount').textContent = message['playerCount']
            roundNumber = message['roundNumber']
            document.getElementById('roundNumber').textContent = roundNumber
            
            for(let i =1;i<=roundNumber;i++){
              let opt = document.createElement('option');
              opt.appendChild(document.createTextNode(i))
              opt.value = i
              select.appendChild(opt)
              if(i == roundNumber)
                opt.selected = 'selected'
            }
            points = message['points']
            document.getElementById('poeni').textContent = String(message['points'])
            pList[username] = points
            
            new Noty({
                  theme : 'metroui',
                  type : 'success',
                  layout : 'topRight',
                  text : message['MSG'],
                  timeout : 5000,
                  progressBar :true
                }).show()
            if(message['roundActive']){  
              readyBtn.disabled = true;
              disableAllInputFields()
              new Noty({
                  theme : 'metroui',
                  type : 'info',
                  layout : 'topRight',
                  text : 'Sačekajte sledecu rundu da bi ste nastavili da igrate!',
                  timeout : 5000,
                  progressBar :true
                }).show()
            }
          }else{
            $('#maxDiv').hide()
            new Noty({  
                  theme : 'metroui',
                  type : 'warning',
                  layout : 'topRight',
                  text : message['ERR_MSG'],
                  timeout : 5000,
                  progressBar :true
                }).show()
          }

        })  
        //ako soba ne postoji response ako je if(room in localData) tacan
        socket.on("roomNotExist",message =>{
          new Noty({  
                  theme : 'metroui',
                  type : 'warning',
                  layout : 'topRight',
                  text : message['ERR_MSG'],
                  timeout : 5000,
                  progressBar :true
                }).show()
          $("#maxDiv").hide()
        })
        //updatavnje igraca nakon kikovanja
        socket.on('playerCountUpdate', message =>{
         
          document.getElementById('lblPlayersReady').textContent = message
        })
        //error tokom kreiranja runde
        socket.on('createRoundResponse',message =>{
            gameStarted = false
            ready = false
            readyBtn.style.backgroundColor = 'red'
            readyBtn.textContent = 'Not ready!' 
            new Noty({
                theme : 'metroui',
                type : 'error',
                layout : 'topRight',
                text : message['ERR_MSG'],
                timeout : 5000,
                progressBar :true
              }).show()
              
        })
        // response ako bude problema tokom evaluacije
        socket.on('evaluationResponse',message=>{
          new Noty({
                theme : 'metroui',
                type : 'success',
                layout : 'topRight',
                text : message['ERR_MSG'],
                timeout : 5000,
                progressBar :true
              }).show()
              roundNumber = message['roundNumber']
             
              let opt = document.createElement('option')
              opt.appendChild(document.createTextNode(roundNumber))
              opt.value = roundNumber
              opt.selected = 'selected'
              select.appendChild(opt)
              document.getElementById('roundNumber').textContent = roundNumber
              document.getElementById('lblPlayersReady').textContent = message['playersReady']
        })
        //response ako bude problema u datacolleturu lose napravljeno
        socket.on('dataCollectorResponse',message=>{
          new Noty({
                theme : 'metroui',
                type : 'success',
                layout : 'topRight',
                text : message['ERR_MSG'],
                timeout : 5000,
                progressBar :true
              }).show()
        })
        //event za pocinjane runde 
        // ovde se desava disablujenje odredjenih funckija 
        // odredjivanje regexa
        socket.on('gameStartNotification', message => {
         
          if(message['Success'] == true){
            if(sessionToken == localStorage.getItem('sessionToken'))
            {
              new Noty({
                  theme : 'metroui',
                  type : 'success',
                  layout : 'topRight',
                  text : message['MSG'],
                  timeout : 5000,
                  progressBar :true
                }).show()
                document.getElementById('lblPlayersReady').textContent = 0
                hideAllHelp()
                disableAllPButtons()
                disableHistoryReq()
                currentLetter = message['currentLetter']
                cirilicaLetter = message['cirilicaLetter']
                //OVDE JE GRESKA zato trebalo bi da postoji C ILI Č 
                if(currentLetter == "ć")
                  dataReg = new RegExp(`^(c|ć|ћ)[A-Za-zа-шА-ШčČćĆžŽšŠđĐђјљњћџЂЈЉЊЋЏ ]{1,41}$`,'g')
                else if(currentLetter == "č")
                  dataReg = new RegExp(`^(c|č|ч)[A-Za-zа-шА-ШčČćĆžŽšŠđĐђјљњћџЂЈЉЊЋЏ ]{1,41}$`,'g')
                else if(currentLetter == "lj" || currentLetter == "nj")
                  dataReg = new RegExp(`^$(${currentLetter}|${cirilicaLetter})[A-Za-zа-шА-ШčČćĆžŽšŠđĐђјљњћџЂЈЉЊЋЏ ]{1,40}$`,'g')
                else if(currentLetter == "dž")
                  dataReg = new RegExp(`^(dz|dž|џ)[A-Za-zа-шА-ШčČćĆžŽšŠđĐђјљњћџЂЈЉЊЋЏ ]{1,40}$`,'g')
                else if(currentLetter == "đ")
                  dataReg = new RegExp(`^(đ|dj|ђ)[A-Za-zа-шА-ШčČćĆžŽšŠđĐђјљњћџЂЈЉЊЋЏ ]{1,40}$`,'g') 
                else if(currentLetter == "ž")
                  dataReg = new RegExp(`^(z|ž|ж)[A-Za-zа-шА-ШčČćĆžŽšŠđĐђјљњћџЂЈЉЊЋЏ ]{1,41}$`,'g')
                else if(currentLetter == "š")
                  dataReg = new RegExp(`^(s|š|ш)[A-Za-zа-шА-ШčČćĆžŽšŠđĐђјљњћџЂЈЉЊЋЏ ]{1,41}$`,'g')
                else
                  dataReg = new RegExp(`^(${currentLetter}|${cirilicaLetter})[A-Za-zа-шА-ШčČćĆžŽšŠđĐђјљњћџЂЈЉЊЋЏ ]{1,41}$`,'g')
                document.getElementById('currentLetter').textContent = currentLetter
                console.log(dataReg)
              let duration = 61
                myInterval = setInterval(()=>{
                duration--
                timer.innerHTML = duration
                if(duration == 0){
                  
                  clearInterval(myInterval)
                }
              },1000)
              readyBtn.innerText = "Gotovo";
              gameStarted = true;
              ready =false;
              enableAllInputFields()
              clearAllInputFields()
            }
            else{
              disableAllInputFields();
              disableAllPButtons();
              readyBtn.disabled = true;
              
              //daj ovde neki notifikation
              new Noty({
                  theme : 'metroui',
                  type : 'error',
                  layout : 'topRight',
                  text : "Mozete biti samo u jednoj sobi u isto vreme.",
                  timeout : 4000,
                  progressBar :true
                }).show()
              setTimeout(()=>{
                location.reload()
              },4000)
              
            }
          }else{
            //game unable to start
          }
          
        })
        socket.on('playerLeft',message=>{
          if(message != username)
            new Noty({
              theme : 'metroui',
                    type : 'info',
                    layout : 'topRight',
                    text : message,
                    timeout : 4000,
                    progressBar :true
            }).show()
        })
        socket.on('playerList',message=>{
          //ovde treba da se reqestaju poeni takodje..
          console.log(message)
          if(message["MODE"]== "START"){
            let keys = Object.keys(message['players'])
            for(let i =0;i<keys.length;i++){
              if(!(keys[i] in pList))
              {
                pList[keys[i]] = message['players'][keys[i]]               
                $("ul").append(`<li id="${keys[i]}"><label class="nameLabel" onclick="historyReq('${keys[i]}')">${keys[i]}</label> | <label id="${keys[i]}Points">${message['players'][keys[i]]}</label> <span onclick="voteKick(\'${keys[i]}\')" class="mySpan" id="span${keys[i]}">&#10006;</span></li>`);
              }
            }
          }else if(message["MODE"] == "UPDATE"){
            let keys = Object.keys(message['players'])
            console.log(keys)
            for(let i =0;i<keys.length;i++){
              
              try{
                document.getElementById(keys[i]+'Points').textContent = Number(document.getElementById(keys[i]+'Points').textContent) + Number(message['players'][keys[i]])

              }catch(TypeError){

              }
            }
          }
        })
        //funckicja za glasanje
        function voteKick(usernameM){
          socket.emit('voteKickStart',({usernameM,roomCode}))
          //na result eventu enabluj
          let keys = Object.keys(pList)
          for(let i=0;i<keys.length;i++){
            $(`#span${keys[i]}`).css('pointer-events','none')
          }
          
        }
        //start vote kick event prikazuje popup za glasanje za izbacivanje
        socket.on('startVoteKickResponse',message=>{
          if(message['Success']){
            myAlert(message['username'])
            let keys = Object.keys(pList)
            for(let i=0;i<keys.length;i++){
                $(`#span${keys[i]}`).css('pointer-events','none')
            }
            new Noty({
                theme : 'metroui',
                type : 'info',
                layout : 'topRight',
                text : message['MSG'],
                timeout : 3000,
                progressBar :true
              }).show()
          }
          else
          {
            new Noty({
                theme : 'metroui',
                type : 'info',
                layout : 'topRight',
                text : message['ERR_MSG'],
                timeout : 5000,
                progressBar :true
              }).show()
          }
        })
        //player ready response
        socket.on('playerReadyResponse' , message =>{
          
          if(message['Success'] == false){
            if(message['ERR_CODE'] == 1){
              //reset ready button
              readyBtn.style.backgroundColor = 'red'
              readyBtn.textContent = "Nisi spreman!"
              document.getElementById('lblPlayersReady').textContent = 0
              new Noty({
                theme : 'metroui',
                type : 'error',
                layout : 'topRight',
                text : message['ERR_MSG'],
                timeout : 5000,
                progressBar :true
              }).show()
            }
          }
          else{
            if(message['CODE'] == 1)
            {
              if(message['STATE'] == 'Spreman'){
                readyBtn.style.backgroundColor = 'green';               
              }else{
                readyBtn.style.backgroundColor = 'red';               
              }
              readyBtn.textContent = message['STATE']
              new Noty({
                theme : 'metroui',
                type : 'success',
                layout : 'topRight',
                text : message['MSG'],
                timeout : 5000,
                progressBar :true
              }).show()
            }
          }
          readyBtn.disabled = false;
        })
        //player disc messsage event
        socket.on('discMessage',message =>{
          new Noty({
              theme : 'metroui',
              type : 'info',
              layout : 'topRight',
              text : message,
              timeout : 5000,
              progressBar :true
            }).show()
        })
        //playerjoin event ispis
        socket.on('playerJoinMsg', message =>{    
          
            new Noty({
              theme : 'metroui',
              type : 'success',
              layout : 'topRight',
              text : message,
              timeout : 5000,
              progressBar :true
            }).show()
        })
        //roundnumberupdate event
        socket.on('roundNumberUpdate', message=>{
          roundNumber = message
          select = document.getElementById('roundSelect')
          let opt = document.createElement('option')
          opt.appendChild(document.createTextNode(roundNumber))
          opt.value = roundNumber
          opt.selected = 'selected'
          select.appendChild(opt)
          document.getElementById('roundNumber').textContent = roundNumber 
        })
        //points socket listener event gde se dodaju poeni 
        socket.on('points' , message =>{         
          readyBtn.disabled = false;
          if(!message['Success'])
          {
            new Noty({
                theme : 'metroui',
                type : 'error',
                layout : 'topRight',
                text : 'Problem prilikom evaluacije, runda ponistena',
                timeout : 5000,
                progressBar :true
              }).show()
            
          }
          else
          {
            enableHistoryReq()
            new Noty({
                theme : 'metroui',
                type : 'success',
                layout : 'topRight',
                text : 'Evaluacija zavrsena',
                timeout : 5000,
                progressBar :true
              }).show()  
              for(let i=0;i<fields.length;i++){
                try
                {                  
                  poeni = message['result'][i][$(`#input${fields[i]}`).val().toLowerCase()]
                  if(poeni != undefined){
                    document.getElementById(`input${fields[i]}`).value += '  + ' +  poeni
                    points += Number(poeni)
                  }
                  else{
                    document.getElementById(`input${fields[i]}`).value += '  + 0'
                    if(document.getElementById(`input${fields[i]}`).value != "")
                      $(`#predloziBtn${fields[i]}`).prop("disabled", false)
                  }
                }
                catch(TypeError){
                  
                  document.getElementById(`input${fields[i]}`).value += '  + 0'
                  if(document.getElementById(`input${fields[i]}`).value != "")
                    $(`#predloziBtn${fields[i]}`).prop("disabled", false)
                }
              }
              
              document.getElementById('poeni').textContent = String(points)
          }
          roundNumber = message['roundNumber']
          select = document.getElementById('roundSelect')
          let opt = document.createElement('option')
          opt.appendChild(document.createTextNode(roundNumber))
          opt.value = roundNumber
          opt.selected = 'selected'
          select.appendChild(opt)
          document.getElementById('roundNumber').textContent = roundNumber
          document.getElementById('lblPlayersReady').textContent = message['playersReady']          
        })
        //err listner
        socket.on('pointsErr',message=>{
          new Noty({
              theme : 'metroui',
              type : 'success',
              layout : 'topRight',
              text : message['MSG'],
              timeout : 5000,
              progressBar :true
            }).show()
            setTimeout(()=>{location.reload()},6000)
            $('#maxDiv').hide()
            
        })
        //socket listener za kraj runde od strane servera nakon isteka vremena ili nakon sto je neki drugi igrac zavrsio
        socket.on('roundEnd',message =>{
            
            t0 = performance.now()
            hideAllHelp()
            readyBtn.disabled = true;
            if(message['Success']){            
              new Noty({
                theme : 'metroui',
                type : 'success',
                layout : 'topRight',
                text : message['MSG'],
                timeout : 5000,
                progressBar :true
              }).show()
              var allValid = true
              var data = []           
              for(let i=0;i<fields.length;i++){
                if(!dataReg.test($(`#input${fields[i]}`).val().toLowerCase())){
                  data.push('')               
                }else{
                  data.push($(`#input${fields[i]}`).val().toLowerCase().trim())
                }              
                dataReg.lastIndex =0;       
              }           
              if(!kicked)
                socket.emit('roundData',({username,roomCode,data,roundNumber}))
              historyData[username][roundNumber] = data           
              disableAllInputFields()
              gameStarted = false
              ready = false
              readyBtn.style.backgroundColor = 'red'
              readyBtn.textContent = 'Not ready!'           
              clearInterval(myInterval)
              timer.textContent = '0'
            }
          
        })    
        // ovo ne radi 
        window.addEventListener('unload',(e) =>{
          if(!readyBtn.style.backgroundColor == "red" && !readyBtn.innerText == 'Not ready!')
            socket.emit('disconnectMSG',({username,roomCode}))         
        })      
        //ready button click event listner // sluzi za ready upovanje i slanje zahteva za kraj runde ako su sva polja validno popunjena
        readyBtn.addEventListener('click',(e) =>{
          if(!gameStarted){
            if(!ready){
              socket.emit('playerReady',roomCode)
              readyBtn.disabled = true;
              ready = true
            }
            else{
              socket.emit('playerUnReady',roomCode)            
              readyBtn.disabled = true;
              ready = false
            }
          }else{
            
            data =[]
            hideAllHelp()
            var allValid = true
            for(let i=0;i<fields.length;i++){
              if(!dataReg.test($(`#input${fields[i]}`).val().toLowerCase())){
                $(`#help${fields[i]}`).show() 
                allValid = false
                data.push('')
                
              }else{
                data.push($(`#input${fields[i]}`).val().toLowerCase().trim())
              }
              dataReg.lastIndex = 0             
            }
            if(allValid){
              readyBtn.disabled = true;     
              if(!kicked){
              socket.emit('clientEndRound',({username,roomCode,data,roundNumber}))
              }
              historyData[username][roundNumber] = data
              disableAllInputFields()
              gameStarted = false
              ready = false
              readyBtn.style.backgroundColor = 'red'
              readyBtn.textContent = 'Nisi spreman'             
              clearInterval(myInterval)
              timer.textContent = '0'
            }
          }
        })

        //windows on load event gde se regexuju podaci radi zastite i salje zahtev za ulazak u sobu
        window.onload = (e)=>{
            const {username, roomCode} = Qs.parse(location.search,{
                ignoreQueryPrefix: true
            })
            let roomReg = /^[A-Za-z0-9]{8}$/g
            const usernameReg = /^[A-Za-zčČćĆžŽšŠđĐ ]{4,30}$/g
            const sessionReg = /^[A-Za-z0-9/+]{48}$/g
            if(roomReg.test(roomCode) && usernameReg.test(username)){
                const sessionToken = localStorage.getItem('sessionToken') 
                if(sessionReg.test(sessionToken))
                  socket.emit('joinRoomReq',({username,roomCode,sessionToken}))
                else
                  new Noty({
                    theme : 'metroui',
                    type : 'error',
                    layout : 'topRight',
                    text : "Session token nije validan!",
                    timeout : 5000,
                    progressBar :true
                  }).show()

            }
            else{
                  new Noty({
                  theme : 'metroui',
                  type : 'error',
                  layout : 'topRight',
                  text : "Format sobe ili korisnickog imena nisu validni!",
                  timeout : 5000,
                  progressBar :true
                }).show()
  
            }
        }
        //Funkcija za predlaganje odgovora
        function predlozi(field){          
          let val = $(`#input${field}`).val().toLowerCase().split('+')[0].trim()          
          if(dataReg.test(val)){
            let k = kDict[field]
            socket.emit("predlagac",({val,currentLetter,k}));                      
            new Noty({
                  theme : 'metroui',
                  type : 'success',
                  layout : 'topRight',
                  text : "Vas odgovor je uspesno predložen!",
                  timeout : 5000,
                  progressBar :true
                }).show()
          }
          else{
            $(`#help${field}`).show()
          }
          dataReg.lastIndex = 0;
          document.getElementById(`predloziBtn${field}`).disabled = true;
        }

    </script>
</html>
<!-- KORISTI TIMER NA CLIENT SIDU-->